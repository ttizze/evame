# AGENTS.md

常に日本語で返答する｡
コストや時間を度外視し､最もシンプルで､最も素晴らしいものを作るよう常に努める｡
仕様は要求を実現するための最もシンプルなものを目指す｡

## 実行環境

- パッケージランナー: `bun`
- フレームワーク: Next.js (App Router)

## 作業手順

1. 指示が曖昧な場合は必ず確認する。
2. コード/設定/リポジトリ内ドキュメントを確認し、分からない点だけ質問する。
3. 疑問点が解消されたら自動で作業を開始する｡可能な限り自動で作業する｡
4. 作業は､t-wadaのTDDで行う｡
5. 作業が完了したら､biomeとtypecheckを実行してエラーが出たら直す。
6. 完了したらリファクタして､すべてのテストが通っていることを確認する｡
7. 完了したらreviewを行う｡
8. reviewが完了したらPRを作成する。
9. PRでコメントが来たら対応する｡

## コード規約

### 全般

- 不要なコード､冗長なコードは削除する｡
- 実際に使わない引数・props・オプションは追加しない（将来用の予防線も不可）。必要になってから追加する。
- 厳密な型定義のため､基本的に引数は必須のものを使う｡どうしてものときは `| null` で対応する。
- `useEffect` はどうしても書かないとうまくいかない場合のみ書く。
- UIの文言は各ロケールに合わせて翻訳する。
- ライブラリを使用する場合は skill の context7 を用い､公式の使い方等の裏取りをしてから実行する。

### 書かないもの

- 単純なデータ形状（DTO）に専用の型宣言（`interface` / `type`）→ 推論かインライン型で書く。
- `join`/代入だけの薄いラッパー関数 → 呼び出し側に直接書く。
- 用途が1つしかない共通化。`utils.ts` を雑多置き場にしない。
- `export *` だけの中継ファイル（barrel/re-export専用ファイル）を作らない。

### 薄いラッパー関数の禁止（強制）

- 以下は新規追加禁止:
- `join(...)` した値を返すだけの関数
- `const x = ...; return x;` だけの関数
- 既存関数を1回呼ぶだけの別名関数（意味の追加がないもの）
- 環境変数のフォールバック1行だけを切り出した関数
- 1箇所でしか使わない `assertXxx` / `validateXxx` などの単発ガード関数
- `export *` だけで依存を隠す中継ファイル
- 原則: まず呼び出し側に直接書く。重複が発生してから共通化する。
- 例外: 2箇所以上で同じ処理を使い、かつ業務上の意味/検証/安全性を1箇所に固定したい場合のみ関数化可。
- 例外時は変更説明に「複数利用箇所」と「関数化しないと壊れる理由」を1行で明記する。

## 配置ポリシー

### 原則

- **近接配置**: コードは「主な呼び出し元」に最も近い場所へ置く。テストは対象ファイルの隣。
- **境界志向**: APIで実行する処理はAPI境界の内側に、App Route から使う補助はその境界の内側に置く。
- **凝集重視**: 互いに強く関連する処理は同じスコープにまとめ、スコープ横断を避ける。

### 責務の定義

| レイヤー | 責務 | 備考 |
|----------|------|------|
| `domain` | 業務概念・業務ルール | 純粋関数。I/O依存を持ち込まない |
| `service` | ユースケース実行 | 複数の domain を組み合わせ、`db` / `infra` を呼んで処理を完了させる |
| `db` | DB接続してデータを返す/書くだけ。加工・判定ロジックを持たない | ファイル名は `queries.ts` / `mutations.ts`（接頭辞付き不可） |
| `infra` | 外部サービスとの接続を担うラッパー（SDK呼び出し、API通信、キュー投入など） | 例: QStash, S3, メール送信 |
| `utils` | 業務語彙を含まない汎用処理 | — |

### infra の判定基準

`infra` に置くのは **外部サービスのSDK/APIを直接呼び出すコードだけ**。判定は「`import` しているものが外部サービスのSDKか？」で行う。

- **infra**: `@upstash/qstash`, `@aws-sdk/*`, `nodemailer` などの外部SDKを `import` して呼び出す。
- **infra ではない**: DBからトークンを引いて照合する、ハッシュを比較する → これは `db` や `domain`。

「認証」「通知」などの概念名で判断しない。実装が外部SDKを叩いているかどうかだけで判断する。

### domain / utils の判定

- `domain`: 仕様変更の起点が業務要件で、業務語彙（slug, revision, publish, archive など）を含む。
- `utils`: 仕様変更の起点が技術仕様（URL/文字列/日時/HTTP/変換処理など）で、業務語彙を持たない。
- 迷う場合は判断根拠を1行で共有して確認を取る。曖昧なまま `domain` に置かない。

### App Router のルール

- ルート直下（`route.ts` / `page.tsx` / `layout.tsx` と同階層）の補助ディレクトリは必ず `_` を付ける（例: `_db`, `_domain`, `_service`, `_infra`, `_utils`）。
- `route.ts` / `page.tsx` / `layout.tsx` は境界責務だけを持つ（入出力、認証、レスポンス整形）。
- 分岐を持つ純粋ロジックを境界ファイルに直書きしない。業務語彙 → `_domain`、汎用/技術補助 → `_utils`、ユースケース実行 → `_service`。

### 共通化のルール

- 2箇所以上で同種の処理を使う場合は共通化する（テストコードは判定対象に含めない）。
- 共通化先は利用箇所 A/B の最小共通祖先ディレクトリに置く（A配下やB配下に偏らせない）。
- 1箇所でしか使わない処理は呼び出し元の隣に置く。
- `db` 処理も同じ配置原則に従う（単独利用は近接、複数利用は最小共通祖先）。

### 変更説明

- 配置（domain/service など）とファイルパスを明示する。
- どこから使われる処理か（呼び出し元ファイル）と、その配置にした理由を明記する。
- 大きな編集前に方針を短く共有する。

## テスト

- t-wadaスタイルのTDDで進める（Red → Green → Refactor）。
- テスト名は自然な日本語で具体的にする（例: 何をクリック/何が起きるかを明記）。
- `domain`: 十分な量のユニットテストを書く（境界値・異常系を含む）。
- `service`: ハッピーパスのテストを書く。
- 検証は変更箇所に近い範囲から段階的に実施。

## バグ修正

1. バグの原因を特定してから、根本的な原因を変更して修正する。
2. バグが再現するテストを書く。
3. コードをテストが通るまで直す。
4. テストが通ったら PR。
5. バグが再現しない時は再現手順をユーザーに聞く。

## ドキュメント

- 入口一覧は `docs/README.md#入口` を参照。
- 指摘された内容は自動で AGENTS.md に反映・更新する。

## セキュリティ

- `.env` のキーは外部に出さない。ログ/PR/エラーメッセージに含めない。
- 機密値はダミー化・マスクして共有。

## 提案の仕方

- 明確な代替案がある場合のみ簡潔に提案（コスト/メリットを1行で）。
- 不確実な点は質問して前提をそろえる。

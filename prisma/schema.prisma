generator client {
  provider = "prisma-client-js"
  features = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  image               String               @default("https://evame.tech/avatar.png")
  plan                String               @default("free")
  totalPoints         Int                  @default(0) @map("total_points")
  isAI                Boolean              @default(false) @map("is_ai")
  provider            String               @default("Credentials")
  createdAt           DateTime             @default(now()) @map("created_at")
  updatedAt           DateTime             @default(now()) @updatedAt @map("updated_at")
  name                String               @default("new_user")
  handle              String               @unique @default(cuid())
  profile             String               @default("")
  id                  String               @id @default(dbgenerated("(uuid_generate_v7())::text"))
  email               String               @unique
  twitterHandle       String               @default("")
  emailVerified       Boolean?
  accounts            Account[]
  following           Follow[]             @relation("follower")
  followers           Follow[]             @relation("following")
  geminiApiKey        GeminiApiKey?
  likePages           LikePage[]
  actedNotifications  Notification[]       @relation("NotificationActor")
  notifications       Notification[]       @relation("UserNotifications")
  pageComments        PageComment[]
  pages               Page[]
  segmentTranslations SegmentTranslation[]
  sessions            Session[]
  translationJobs     TranslationJob[]
  translationVotes    TranslationVote[]
  credential          UserCredential?
  userSettings        UserSetting?

  @@map("users")
}

model UserSetting {
  id            Int      @id @default(autoincrement())
  userId        String   @unique @map("user_id")
  targetLocales String[] @default([]) @map("target_locales")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at")
  user          User     @relation(fields: [userId], references: [id])

  @@map("user_settings")
}

model UserCredential {
  id       Int    @id @default(autoincrement())
  password String
  userId   String @unique @map("user_id")
  user     User   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("user_credentials")
}

model GeminiApiKey {
  id     Int    @id @default(autoincrement())
  apiKey String @default("") @map("api_key")
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("gemini_api_keys")
}

model Follow {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now()) @map("created_at")
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  follower    User     @relation("follower", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

model TranslationJob {
  id        Int               @id @default(autoincrement())
  pageId    Int
  userId    String?
  locale    String
  aiModel   String
  status    TranslationStatus @default(PENDING)
  progress  Int               @default(0)
  error     String            @default("")
  createdAt DateTime          @default(now())
  updatedAt DateTime          @default(now()) @updatedAt
  page      Page              @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user      User?             @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("translation_jobs")
}

model Page {
  id                          Int                          @id
  slug                        String                       @unique
  createdAt                   DateTime                     @default(now()) @map("created_at")
  sourceLocale                String                       @default("unknown") @map("source_locale")
  updatedAt                   DateTime                     @default(now()) @updatedAt @map("updated_at")
  status                      PageStatus                   @default(DRAFT)
  userId                      String                       @map("user_id")
  mdastJson                   Json                         @map("mdast_json")
  order                       Int                          @default(0)
  parentId                    Int?                         @map("parent_id")
  likePages                   LikePage[]
  notifications               Notification[]
  pageComments                PageComment[]
  pageLocaleTranslationProofs PageLocaleTranslationProof[]
  pageView                    PageView?
  content                     Content                      @relation(fields: [id], references: [id], onDelete: Cascade)
  parent                      Page?                        @relation("ParentPage", fields: [parentId], references: [id])
  children                    Page[]                       @relation("ParentPage")
  user                        User                         @relation(fields: [userId], references: [id], onDelete: Cascade)
  tagPages                    TagPage[]
  translationJobs             TranslationJob[]

  @@index([parentId])
  @@index([createdAt])
  @@index([parentId, order])
  @@index([userId])
  @@index([slug])
  @@map("pages")
}

model PageView {
  pageId Int  @id
  count  Int  @default(0)
  page   Page @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@map("page_views")
}

model PageLocaleTranslationProof {
  id                     Int                    @id @default(autoincrement())
  pageId                 Int                    @map("page_id")
  locale                 String
  translationProofStatus TranslationProofStatus @default(MACHINE_DRAFT) @map("translation_proof_status")
  page                   Page                   @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, locale])
  @@index([translationProofStatus])
  @@map("page_locale_translation_proofs")
}

model LikePage {
  id        Int      @id @default(autoincrement())
  pageId    Int      @map("page_id")
  createdAt DateTime @default(now()) @map("created_at")
  guestId   String?  @map("guest_id")
  userId    String?  @map("user_id")
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, pageId])
  @@unique([guestId, pageId])
  @@index([userId])
  @@index([pageId])
  @@map("like_pages")
}

model Tag {
  id    Int       @id @default(autoincrement())
  name  String    @unique
  pages TagPage[]

  @@index([name])
  @@map("tags")
}

model TagPage {
  tagId  Int
  pageId Int
  page   Page @relation(fields: [pageId], references: [id], onDelete: Cascade)
  tag    Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([tagId, pageId])
  @@index([tagId])
  @@index([pageId])
  @@map("tag_pages")
}

model PageComment {
  id            Int            @id
  pageId        Int            @map("page_id")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @default(now()) @updatedAt @map("updated_at")
  locale        String
  userId        String         @map("user_id")
  parentId      Int?           @map("parent_id")
  mdastJson     Json           @map("mdast_json")
  isDeleted     Boolean        @default(false) @map("is_deleted")
  lastReplyAt   DateTime?      @map("last_reply_at")
  replyCount    Int            @default(0) @map("reply_count")
  notifications Notification[]
  content       Content        @relation(fields: [id], references: [id], onDelete: Cascade)
  page          Page           @relation(fields: [pageId], references: [id], onDelete: Cascade)
  parent        PageComment?   @relation("CommentReplies", fields: [parentId], references: [id])
  replies       PageComment[]  @relation("CommentReplies")
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([pageId, parentId, createdAt])
  @@index([parentId, isDeleted, createdAt])
  @@index([userId])
  @@map("page_comments")
}

model Account {
  userId                String
  providerId            String    @map("provider")
  accountId             String    @map("providerAccountId")
  refreshToken          String?   @map("refresh_token")
  accessToken           String?   @map("access_token")
  scope                 String?
  idToken               String?   @map("id_token")
  createdAt             DateTime  @default(now()) @map("created_at")
  id                    String    @id @default(dbgenerated("(uuid_generate_v7())::text"))
  password              String?
  refreshTokenExpiresAt DateTime?
  updatedAt             DateTime  @default(now()) @updatedAt @map("updated_at")
  accessTokenExpiresAt  DateTime? @map("expires_at")
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Notification {
  id                   Int                 @id @default(autoincrement())
  userId               String              @map("user_id")
  type                 NotificationType
  read                 Boolean             @default(false)
  createdAt            DateTime            @default(now()) @map("created_at")
  actorId              String              @map("actor_id")
  pageCommentId        Int?                @map("page_comment_id")
  pageId               Int?                @map("page_id")
  segmentTranslationId Int?                @map("segment_translation_id")
  actor                User                @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  pageComment          PageComment?        @relation(fields: [pageCommentId], references: [id])
  page                 Page?               @relation(fields: [pageId], references: [id])
  segmentTranslation   SegmentTranslation? @relation(fields: [segmentTranslationId], references: [id])
  user                 User                @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([actorId])
  @@map("notifications")
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now()) @map("created_at")
  id           String   @id @default(dbgenerated("(uuid_generate_v7())::text"))
  ipAddress    String?
  updatedAt    DateTime @default(now()) @updatedAt @map("updated_at")
  userAgent    String?
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@id([identifier, token])
  @@map("verification_tokens")
}

model Verification {
  id         String    @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verifications")
}

model Content {
  id           Int          @id @default(autoincrement())
  kind         ContentKind
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @default(now()) @updatedAt @map("updated_at")
  importFileId Int?         @map("import_file_id")
  importFile   ImportFile?  @relation(fields: [importFileId], references: [id])
  pageComment  PageComment?
  page         Page?
  segments     Segment[]

  @@index([kind])
  @@map("contents")
}

model SegmentType {
  id       Int            @id @default(autoincrement())
  label    String
  key      SegmentTypeKey
  segments Segment[]

  @@unique([key, label])
  @@index([key])
  @@index([label])
  @@map("segment_types")
}

model Segment {
  id                    Int                     @id @default(autoincrement())
  contentId             Int                     @map("content_id")
  number                Int
  text                  String
  textAndOccurrenceHash String                  @map("text_and_occurrence_hash")
  createdAt             DateTime                @default(now()) @map("created_at")
  segmentTypeId         Int                     @map("segment_type_id")
  annotationTargets     SegmentAnnotationLink[] @relation("AnnotationSegment")
  annotations           SegmentAnnotationLink[] @relation("MainSegment")
  metadata              SegmentMetadata[]
  segmentTranslations   SegmentTranslation[]
  content               Content                 @relation(fields: [contentId], references: [id], onDelete: Cascade)
  segmentType           SegmentType             @relation(fields: [segmentTypeId], references: [id])

  @@unique([contentId, number])
  @@unique([contentId, textAndOccurrenceHash])
  @@index([contentId])
  @@index([textAndOccurrenceHash])
  @@map("segments")
}

model SegmentAnnotationLink {
  mainSegmentId       Int      @map("main_segment_id")
  annotationSegmentId Int      @map("annotation_segment_id")
  createdAt           DateTime @default(now()) @map("created_at")
  annotationSegment   Segment  @relation("AnnotationSegment", fields: [annotationSegmentId], references: [id], onDelete: Cascade)
  mainSegment         Segment  @relation("MainSegment", fields: [mainSegmentId], references: [id], onDelete: Cascade)

  @@id([mainSegmentId, annotationSegmentId])
  @@index([mainSegmentId])
  @@index([annotationSegmentId])
  @@map("segment_annotation_links")
}

model SegmentMetadataType {
  id            Int               @id @default(autoincrement())
  key           String            @unique
  label         String
  metadataItems SegmentMetadata[]

  @@map("segment_metadata_types")
}

model SegmentMetadata {
  id             Int                 @id @default(autoincrement())
  segmentId      Int                 @map("segment_id")
  metadataTypeId Int                 @map("metadata_type_id")
  value          String
  createdAt      DateTime            @default(now()) @map("created_at")
  metadataType   SegmentMetadataType @relation(fields: [metadataTypeId], references: [id], onDelete: Cascade)
  segment        Segment             @relation(fields: [segmentId], references: [id], onDelete: Cascade)

  @@unique([segmentId, metadataTypeId, value])
  @@index([metadataTypeId])
  @@index([segmentId])
  @@map("segment_metadata")
}

model SegmentTranslation {
  id            Int               @id @default(autoincrement())
  segmentId     Int               @map("segment_id")
  locale        String
  text          String
  point         Int               @default(0)
  createdAt     DateTime          @default(now()) @map("created_at")
  userId        String            @map("user_id")
  notifications Notification[]
  segment       Segment           @relation(fields: [segmentId], references: [id], onDelete: Cascade)
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  votes         TranslationVote[]

  @@index([segmentId, locale])
  @@index([userId])
  @@map("segment_translations")
}

model TranslationVote {
  translationId Int                @map("translation_id")
  userId        String             @map("user_id")
  isUpvote      Boolean            @map("is_upvote")
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @default(now()) @updatedAt @map("updated_at")
  translation   SegmentTranslation @relation(fields: [translationId], references: [id], onDelete: Cascade)
  user          User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([translationId, userId])
  @@index([translationId])
  @@index([userId])
  @@map("translation_votes")
}

model ImportRun {
  id         Int          @id @default(autoincrement())
  startedAt  DateTime     @default(now()) @map("started_at")
  finishedAt DateTime?    @map("finished_at")
  status     String       @default("RUNNING")
  files      ImportFile[]

  @@map("import_runs")
}

model ImportFile {
  id          Int       @id @default(autoincrement())
  importRunId Int       @map("import_run_id")
  path        String
  checksum    String
  status      String    @default("PENDING")
  message     String    @default("")
  createdAt   DateTime  @default(now())
  contents    Content[]
  importRun   ImportRun @relation(fields: [importRunId], references: [id], onDelete: Cascade)

  @@map("import_files")
}

enum TranslationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum PageStatus {
  DRAFT
  PUBLIC
  ARCHIVE
}

enum TranslationProofStatus {
  MACHINE_DRAFT
  HUMAN_TOUCHED
  PROOFREAD
  VALIDATED
}

enum NotificationType {
  FOLLOW
  PAGE_COMMENT
  PAGE_LIKE
  PAGE_SEGMENT_TRANSLATION_VOTE
  PAGE_COMMENT_SEGMENT_TRANSLATION_VOTE
}

enum ContentKind {
  PAGE
  PAGE_COMMENT
}

enum SegmentTypeKey {
  PRIMARY
  COMMENTARY
}

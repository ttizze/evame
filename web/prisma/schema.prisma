generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           Int             @id @default(autoincrement())
  email        String          @unique
  password     String?
  name         String
  plan         String          @default("free")
  totalPoints  Int             @default(0) @map("total_points")
  isAI         Boolean         @default(false) @map("is_ai")
  provider      String          @default("Credentials")
  geminiApiKey  String?         @map("gemini_api_key")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  userReadHistory UserReadHistory[]
  apiUsages    ApiUsage[]
  translations TranslateText[]
  votes        Vote[]

  @@map("users")
}
model UserReadHistory {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  pageVersionId    Int      @map("page_version_id")
  readAt            DateTime @default(now()) @map("read_at")
  lastReadDataNumber Int       @default(0) @map("last_read_data_number")
  user              User     @relation(fields: [userId], references: [id])
  pageVersion      PageVersion     @relation(fields: [pageVersionId], references: [id])

  @@unique([userId, pageVersionId])
  @@index([userId])
  @@index([pageVersionId])
  @@map("user_read_history")
}


model Page {
  id             Int             @id @default(autoincrement())
  url            String          @unique @db.VarChar(255)
  createdAt      DateTime        @default(now()) @map("created_at")
  pageVersions   PageVersion[]
  sourceTexts    SourceText[]
  translateTexts TranslateText[]

  @@map("pages")
}

model PageVersionTranslationInfo {
  id            Int         @id @default(autoincrement())
  pageVersionId Int         @map("page_version_id")
  targetLanguage      String      @map("target_language")
  translationTitle         String      @map("translation_title")
  translationStatus        String      @default("pending") @map("translation_status")
  translationProgress      Int          @default(0) @map("translation_progress")
  pageVersion   PageVersion @relation(fields: [pageVersionId], references: [id])

  @@unique([pageVersionId, targetLanguage])
  @@map("page_version_translation_info")
}

model PageVersion {
  id                Int                 @id @default(autoincrement())
  url               String
  title             String
  content           String
  contentHash       Bytes               @map("content_hash")
  pageId            Int                 @map("page_id")
  createdAt         DateTime            @default(now()) @map("created_at")
  page              Page                @relation(fields: [pageId], references: [id])
  sourceTexts       SourceText[]
  pageVersionTranslationInfo PageVersionTranslationInfo[]
  userReadHistory   UserReadHistory[]

  @@unique([url, createdAt])
  @@map("page_versions")
}

model SourceText {
  id             Int             @id @default(autoincrement())
  text           String
  number         Int
  textHash       Bytes           @map("text_hash")
  pageId         Int             @map("page_id")
  pageVersionId  Int             @map("page_version_id")
  page           Page            @relation(fields: [pageId], references: [id])
  pageVersion    PageVersion     @relation(fields: [pageVersionId], references: [id])
  translateTexts TranslateText[]

  @@unique([textHash, pageVersionId, number])
  @@index([textHash])
  @@map("source_texts")
}

model TranslateText {
  id           Int        @id @default(autoincrement())
  targetLanguage     String
  text         String
  sourceTextId Int        @map("source_text_id")
  pageId       Int        @map("page_id")
  userId       Int        @map("user_id")
  point        Int        @default(0)
  editCount    Int        @default(0) @map("edit_count")
  createdAt    DateTime   @default(now()) @map("created_at")
  page         Page       @relation(fields: [pageId], references: [id])
  sourceText   SourceText @relation(fields: [sourceTextId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
  votes        Vote[]

  @@map("translate_texts")
}

model Vote {
  id              Int           @id @default(autoincrement())
  userId          Int           @map("user_id")
  translateTextId Int           @map("translate_text_id")
  isUpvote        Boolean       @map("is_upvote")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")
  translateText   TranslateText @relation(fields: [translateTextId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@unique([translateTextId, userId])
  @@map("votes")
}

model ApiUsage {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  dateTime   DateTime @map("date_time")
  amountUsed Int      @map("amount_used")
  user       User     @relation(fields: [userId], references: [id])

  @@map("api_usage")
}

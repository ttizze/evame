# Agent 開発メモ（Codex CLI 用）

このリポジトリでエージェント作業をする際の最小ガイドです。短時間で安全・確実にタスクを進めるための要点のみまとめています。

## 目的
- 常に最高の提案をする。
- 可能な限り、より良いコードを書く。
- 無意味なコードは書かない。

## 実行環境
- パッケージランナー: `bun`
- フレームワーク: Next.js (App Router)
- ORM/DB: Prisma + PostgreSQL

## よく使うスクリプト
- 依存関係/初期化: `bun run init`（依存インストール → Prisma generate → migrate dev → seed）
- DB セットアップのみ: `bun run db:setup`
- 開発サーバ: `bun run dev`
- 型チェック: `bun run typecheck`
- Lint/整形: `bun run check`
- テスト: `bun run test` / E2E: `bun run test:e2e`

※ `.env` の `DATABASE_URL` を使用。DB が起動していない場合はエラー（P1001 など）になります。必要に応じて `docker compose up -d` を利用してください。

## 作業ルール（重要）
- 変更はタスクに必要な範囲に限定（無関係な修正はしない）。
- 既存の命名・構成・コードスタイルに合わせる。
- 大きな編集や新規ファイル追加の前に方針を短く共有する。
- 検証は変更箇所に近い範囲から段階的に実施。
- 無駄なコードは書かず､シンプルに書く。
- useEffectはどうしても書かないとうまくいかない場合のみ書く。
- mcpのcontext7を用い､裏取りをしてから実行する。
- 不要なコードは削除する｡

## 配置ポリシー

- 近接配置: コードは「主な呼び出し元」に最も近い場所へ置く。
- 境界志向: APIで実行する処理はAPI境界の内側に、App Routeから使う補助はその境界の内側に置く。
- 凝集重視: 互いに強く関連する処理は同じスコープにまとめ、スコープ横断を避ける。

## ツールの使い方（Codex CLI）
- ファイル編集: `apply_patch` を使用（差分最小・一括反映）。
- 調査/実行: `shell` を使用（出力は必要最小限に分割して取得）。
- 計画管理: 必要に応じて `update_plan` で段階を明確化（単純作業では不要）。

## DB と Prisma
- スキーマ変更時は `schema.prisma` を更新 → `bunx prisma migrate dev`。
- シードは `prisma/seed.ts`。`bun run seed` で実行。
- 本番系のマイグレーションは `prisma migrate deploy` を使用（CI/デプロイ時）。

## セキュリティ/秘匿情報
- `.env` のキーは外部に出さない。ログ/PR/エラーメッセージに含めない。
- 機密値はダミー化・マスクして共有。

## 失敗時の対処
- まずは直前変更の差し戻し可能性を検討（最小リバート）。
- エラーメッセージを要点だけ共有し、再現手順と暫定回避策を提示。

## 提案の仕方
- 明確な代替案がある場合のみ簡潔に提案（コスト/メリットを1行で）。
- 不確実な点は質問して前提をそろえる。

---
最短で安全に終わらせることを優先し、必要十分な変更と検証だけを行います。

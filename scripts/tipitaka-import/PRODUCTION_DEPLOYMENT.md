# Tipitaka データの本番環境への投入方法

このドキュメントでは、Tipitakaデータを本番環境のデータベースに投入する際のベストプラクティスを説明します。

## 概要

Tipitakaインポートスクリプトは**冪等性**を持っています。つまり、同じスクリプトを複数回実行しても安全です。既存のデータは更新され、新しいデータのみが追加されます。

## 実行方法

### 前提条件

1. **データベースマイグレーション**: 本番環境のデータベースが最新のマイグレーション状態であること
   ```bash
   bun run db:migrate
   ```

2. **システムユーザーの存在**: `evame` というハンドルのユーザーが存在すること
   - 通常、`bun run seed` で作成されます

3. **環境変数**: `.env` ファイルに `DATABASE_URL` が正しく設定されていること

4. **Tipitakaファイル**: `tipitaka-md*` ディレクトリと `books.json` が存在すること

### 実行手順

#### 方法1: 手動実行（推奨）

```bash
# プロジェクトディレクトリに移動
cd /path/to/project

# 環境変数を読み込んで実行
bun --env-file=.env.production scripts/tipitaka-import.ts
```

または、package.jsonのスクリプトを使用：

```bash
bun run tipitaka
```

#### 方法2: Vercelなどのホスティング環境

Vercelなどのホスティング環境では、以下のいずれかの方法を使用します：

1. **Vercel CLI経由で実行**:
   ```bash
   vercel env pull .env.production
   bun --env-file=.env.production scripts/tipitaka-import.ts
   ```

2. **VercelのPost-Deploy Hook**（推奨しない）:
   - 大量データのため、ビルドプロセスに含めるのは避けるべき
   - ビルドタイムアウトの原因になる可能性がある

3. **別のデプロイスクリプト**:
   - 初回セットアップ時のみ実行する独立したスクリプトとして管理

## 実行時間とパフォーマンス

- **処理時間**: Tipitakaファイルの数によって異なりますが、数百から数千のファイルを処理するため、数時間かかる可能性があります
- **並列処理**: 10ファイルずつ並列処理されます（`CONCURRENCY = 10`）
- **ログ**: 処理の進捗がログに出力されます

## 冪等性の保証

スクリプトは以下の仕組みで冪等性を保証しています：

1. **ページのupsert**: `upsertPageAndSegments` 関数が `slug` ベースで既存ページをチェックし、存在すれば更新、なければ作成します
2. **セグメントの同期**: 既存セグメントは更新され、不要なセグメントは削除されます
3. **セグメントタイプ・メタデータタイプ**: 既存のものはスキップされます

## トラブルシューティング

### エラー: "User with handle evame not found"

システムユーザーが存在しない場合に発生します。以下のコマンドで作成：

```bash
bun run seed
```

### エラー: "DATABASE_URL is not set"

環境変数が設定されていない場合に発生します。`.env` ファイルを確認してください。

### 処理が途中で止まった場合

スクリプトは冪等性があるため、再度実行すれば続きから処理されます。既存のデータは更新され、未処理のデータのみが追加されます。

## データ更新時の対応

Tipitakaデータが更新された場合（XMLファイルの修正など）：

1. 更新されたMarkdownファイルを配置
2. 同じスクリプトを再実行
3. 既存のページは自動的に更新されます

## 注意事項

- **初回セットアップ時**: 大量のデータを投入するため、データベースの容量とパフォーマンスを確認してください
- **実行中**: 長時間実行されるため、SSH接続が切れないように注意してください（`screen` や `tmux` の使用を推奨）
- **ログ**: 実行ログを保存しておくと、問題発生時の調査に役立ちます

```bash
# ログをファイルに保存しながら実行
bun run tipitaka 2>&1 | tee tipitaka-import-$(date +%Y%m%d-%H%M%S).log
```

## ベストプラクティス

1. **初回セットアップ時のみ実行**: 通常は初回セットアップ時のみ実行し、データ更新時のみ再実行
2. **ビルドプロセスに含めない**: `vercel-build` などに含めると、ビルドタイムアウトの原因になる
3. **バックアップ**: 実行前にデータベースのバックアップを取得することを推奨
4. **監視**: 実行中はデータベースの負荷を監視する


